#include "Expo.h"
#include "LibIEEE.h"
#include "IsSubnormal.h"

 t_float Expo_L_Calculation (const t_float E, const t_float r, const t_int_32 k) {    TU_LIB_MATH_IEEE mdy;    TU_LIB_MATH_IEEE mdt;    const t_int_32 C_K_MINUS_ONE = -1;    const t_int_32 C_K_ZERO = 0;    const t_int_32 C_K_ONE = 1;    const t_int_32 C_K_TWENTY = 20;    const t_int_32 C_K_HIG_RANGE = 56;    const t_int_32 C_K_LOW_RANGE = -2;    const t_float C_HALF_FLOAT = 0.5;    const t_float C_MINUS_TWO_FLOAT = -2.0;    const t_float C_MQUART_FLOAT = - 0.25;    t_float result;    t_float val;    t_float y;    #if defined (FLOAT_64)    const t_uint_32 C_ONE_UNSIGNED_MSV = 0x3ff00000;     const t_uint_32 C_EXPONENT = 0x200000;    const t_int_32 C_MINIMUM_TO_MASK = 0x000003ff;    const t_int_32 C_EXP = 20;    const t_float t = C_ONE_FLOAT ;    t_uint_32 hy;    t_uint_32 ly;    t_uint_32 ht;    #elif defined (FLOAT_32)    const t_uint_32 C_ONE_UNSIGNED = 0x3F800000;     const t_uint_32 C_MASK_LAST_16 = 0xFFFF0000;    const t_uint_32 C_MASK_FIRST_16 = 0x0000FFFF;    const t_uint_32 C_HIGW_WORD = 16;    const t_int_32 C_EXP = 23;    const t_uint_32 C_EXP_PO = 0x1000000;    const t_int_32 C_MINIMUM_TO_MASK = 0x0000007f;    t_uint_16 hy;    t_uint_16 ly;    t_uint_16 ht;    t_uint_16 lt;    t_uint_16 kk;    t_uint_32 KP;    t_uint_32 KS;    #endif    if ( k == C_K_MINUS_ONE)    {       result = ((C_HALF_FLOAT * ( r - E )) - C_HALF_FLOAT) + C_ONE_FLOAT;    }     else if(k == C_K_ZERO)    {       result= C_ONE_FLOAT + (r - E);    }    else if(k == C_K_ONE)    {       if (r < C_MQUART_FLOAT)       {          result =  (C_MINUS_TWO_FLOAT * ( E - (r + C_HALF_FLOAT))) + C_ONE_FLOAT;       }       else       {          result =  C_TWO_FLOAT + (C_TWO_FLOAT * ( r - E));       }    }    else if((k <= C_K_LOW_RANGE) || (k >= C_K_HIG_RANGE))    {       mdy.d = C_ONE_FLOAT - (E - r);       hy = mdy.i.high;       ly = mdy.i.low;       #if defined (FLOAT_64)       hy = hy + (t_uint_32) (k << C_SHIFT_EXPONENT);       #elif defined (FLOAT_32)       kk = (t_uint_16) (k << C_SHIFT_EXPONENT);       hy = hy + kk;       #endif       mdy.i.high = hy;       mdy.i.low  = ly;       result = mdy.d;    }    else if((k > C_K_ONE) && (k < C_K_TWENTY))    {        #if defined (FLOAT_64)       mdt.d = t;        ht = C_ONE_UNSIGNED_MSV - (t_uint_32) (C_EXPONENT >> k);       mdt.i.high = ht;       val = mdt.d;       mdy.d = val - (E-r);       hy = mdy.i.high;       hy = hy+ (t_uint_32)(k << C_SHIFT_EXPONENT);       mdy.i.high = hy;       result =  mdy.d + C_ONE_FLOAT;       #elif defined (FLOAT_32)       KS = C_ONE_UNSIGNED - (t_uint_32) (C_EXP_PO >> k);       mdy.i.high = (t_uint_16) (( KS & C_MASK_LAST_16) >> C_HIGW_WORD);          mdy.i.low  = (t_uint_16) ( KS & C_MASK_FIRST_16);               val = mdy.d;        y= val - (E-r);       KP = C_ONE_UNSIGNED + (t_uint_32) (k << C_EXP);           ht  = (t_uint_16) (( KP & C_MASK_LAST_16)>> C_HIGW_WORD);       lt  = (t_uint_16) ( KP & C_MASK_FIRST_16);       mdt.i.high = ht;       mdt.i.low  = lt;        result = (y * mdt.d) +C_ONE_FLOAT;       #endif    }    else    {       #if defined (FLOAT_64)       mdt.d = t;        ht = (t_uint_32)(C_MINIMUM_TO_MASK-k) << C_EXP;       mdt.i.high = ht;       val = mdt.d;       y = r - (E+val);       mdy.d = y + C_ONE_FLOAT;       hy = mdy.i.high;       hy = hy + (t_uint_32) (k << C_EXP);        mdy.i.high = hy;       result = mdy.d + C_ONE_FLOAT;        #elif defined (FLOAT_32)       KS =(t_uint_32) (C_MINIMUM_TO_MASK-k) << C_EXP ;       mdy.i.high = (t_uint_16) (( KS & C_MASK_LAST_16) >> C_HIGW_WORD);       mdy.i.low  = (t_uint_16) ( KS & C_MASK_FIRST_16);       val = mdy.d;       y = r - (E+val);       mdy.d = C_ONE_FLOAT + y;       KP = C_ONE_UNSIGNED + (t_uint_32) (k << C_EXP);           ht  = (t_uint_16) (( KP & C_MASK_LAST_16)>> C_HIGW_WORD);       lt  = (t_uint_16) ( KP & C_MASK_FIRST_16);       mdt.i.high = ht;       mdt.i.low  = lt;       result = (mdy.d* mdt.d) + C_ONE_FLOAT;       #endif    }    return(result); }
