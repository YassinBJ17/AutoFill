############# Copyright Krono-Safe S.A. 2018, All rights reserved #############
#
# This is the ninja build file that contains the operations required to create
# a fully linked PSY APPLICATION.
#
###############################################################################








builddir = R$:/specific_binaries/error_handler/_build_out/ast/error_handler/link

rule kat
  command = "C$:/Program$ Files$ (x86)/Krono-Safe/psyko-8.13.3/bin/kat.exe" $
    --stage=2 $DATABASES $
    --loader-dir "C$:/Program$ Files$ (x86)/Krono-Safe/rtk-power-mpc5777m-module-4.4.5/power-mpc5777m-module/lib/modules/kat" --loader-dir "C$:/Program$ Files$ (x86)/Krono-Safe/psyko-8.13.3/lib/modules/kat" $
    --template $in --output $out --
rule ld
  command = dld -@"$builddir/dld_args.cmdline"
  rspfile = $builddir/dld_args.cmdline
  rspfile_content = -tPPCE200Z710N3VFF -Xelf -limpl $
  -Xrescan-libraries -Xrescan-restart $
  -Xremove-unused-sections -Xunused-sections-list $
  -Xcheck-input-patterns=2 -Xcheck-overlapping $
  -Xgenerate-copytables -Xstack-usage=0x22 $
  -Xbranch-islands-off $
  -m6 $LDFLAGS $OBJECTS $LDSCRIPT -o $out

inspect_options=--stage em --em-config "R$:/specific_binaries/error_handler/_build_out/ast/error_handler/config/error_handlers.ks" $
  --binary-link "R$:/specific_binaries/error_handler/_build_out/ast/error_handler/link/binary_link.ks"
config_end_name=em
config_options=--blink="R$:/specific_binaries/error_handler/_build_out/ast/error_handler/link/binary_link.ks"

rule kmem_config
  command = "C$:/Program$ Files$ (x86)/Krono-Safe/rtk-power-mpc5777m-module-4.4.5/power-mpc5777m-module/psyko/kmem-config-$config_end_name.exe" $
    --kmemory-output $out $
    --kmem-info="C$:/Program$ Files$ (x86)/Krono-Safe/rtk-power-mpc5777m-module-4.4.5/power-mpc5777m-module/config/kmeminfo.ks" $
    --user-config="R$:/specific_binaries/error_handler/_build_out/ast/error_handler/config/error_handlers.ks" $
    $config_options $
    $
    $in

rule kmem_inspect
  command = "C$:/Program$ Files$ (x86)/Krono-Safe/rtk-power-mpc5777m-module-4.4.5/power-mpc5777m-module/psyko/kmem-inspect-app.exe" $
    $inspect_options $
    --output $out $
    --kbinary "$builddir/db/kbinary.ks" $
    --kmemory "R$:/specific_binaries/error_handler/_build_out/ast/error_handler/kmemory_out.ks" $
    $MEMREPORTS $
    -- $in

rule kmem_place
  command = "C$:/Program$ Files$ (x86)/Krono-Safe/rtk-power-mpc5777m-module-4.4.5/power-mpc5777m-module/psyko/kmem-place-app.exe" $
    --kbinary-output $out $
    --kmemory $in $
    --blink "R$:/specific_binaries/error_handler/_build_out/ast/error_handler/link/binary_link.ks" $

###############################################################################
# DBs Generation
###############################################################################

build GenKmemory : phony R$:/specific_binaries/error_handler/_build_out/ast/error_handler/kmemory_out.ks
build R$:/specific_binaries/error_handler/_build_out/ast/error_handler/kmemory_out.ks: kmem_config $
  R$:/specific_binaries/error_handler/_build_out/ast/error_handler/config/kmemory.ks

build $builddir/db/kbinary.ks: kmem_place R$:/specific_binaries/error_handler/_build_out/ast/error_handler/kmemory_out.ks $

###############################################################################
# Generation of the Linker Script
###############################################################################
rule cc
  command = dcc -@$out.cmdline
  rspfile = $out.cmdline
  rspfile_content = $
    -I "C$:/Program$ Files$ (x86)/Krono-Safe/rtk-power-mpc5777m-module-4.4.5/power-mpc5777m-module/include" $
    -tPPCE200Z710N3VFF $
  -O -Xshow-configuration=1 $
  -X3=1 -X6=1 -X7=1 -X9=3 -X15=0 -X16=0 $
  -X18=4 -X19=0 -X25=2 -X32=2 -X43 $
  -X49=8 -X53=1 -X54=4 -X60=1 -X76=4 $
  -X82=1 -X83=3 -X84=0x08 -X97=0 $
  -X98=0 -X118=1 -X139 -X191=1 $
  -Xname-const=.rodata -Xname-string=.rodata $
  -Xname-uconst=.rodata -Xswitch-table-off $
  -Xswitch-array-off -Xno-builtin -Xsavefpr-avoid $
  -H -X8 -X11 -X12 -X21=0 -X23 $
  -X27=0x721A7777 -X28=0xFFFFA3D6 $
  -X29 -X31=0 -X35=0 -X36=1 -X38=0 $
  -X63=0 -X66 -X70=2 -X74=0xFF -X77=0 $
  -X78=0xFF0000 -X86=3 -X88=0 -X91=1 $
  -X103=0x41 -X119=4 -X125 -X127=0 $
  -X146=6 -X147=3 -X153=2 $
  -X154=0x00C000C1 -X180=0 -X194=0 $
  -X199=0 -X404=0x2000 -X419 $
  -X422=10000000 -X423=6000000 -X424=600000 $
  -X451=1 -Xalternate-coloring -Xlocal-data-area=0 $
  -X58=6 -X96=3 -X129=1 $
    $CFLAGS -c -o $out $in

build $builddir/app.dld: kat C$:/Program$ Files$ (x86)/Krono-Safe/rtk-power-mpc5777m-module-4.4.5/power-mpc5777m-module/runtime/app.dld.kat | $builddir/db/kbinary.ks
  DATABASES = --database "$builddir/db/kbinary.ks"

build R$:/specific_binaries/error_handler/_build_out/gen/emo_error_handler.elf: ld | $builddir/app.dld
  LDSCRIPT = "$builddir/app.dld"
  LDFLAGS = "-@O=R$:/specific_binaries/error_handler/_build_out/gen/emo_error_handler.map" "-@E=R$:/specific_binaries/error_handler/_build_out/gen/emo_error_handler_err.map" $
            -uhandle_exception
  OBJECTS = "R$:/specific_binaries/error_handler/_build_out/obj/handle_exception.o" "R$:/specific_binaries/error_handler/_build_out/ast/error_handler/uid.o" $
            $
           

build R$:/specific_binaries/error_handler/_build_out/ast/error_handler/memreport.ks: kmem_inspect R$:/specific_binaries/error_handler/_build_out/gen/emo_error_handler.elf $
  | $builddir/db/kbinary.ks R$:/specific_binaries/error_handler/_build_out/ast/error_handler/kmemory_out.ks

default R$:/specific_binaries/error_handler/_build_out/ast/error_handler/memreport.ks

