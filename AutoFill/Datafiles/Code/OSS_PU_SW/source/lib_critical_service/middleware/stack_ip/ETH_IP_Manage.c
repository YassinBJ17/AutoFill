#include "middleware/stack_ip/ETH_IP_common.h"
#include "middleware/stack_ip/ETH_IP_private.h"
#include "middleware/stack_ip/ETH_IP_conf.h"
#include "middleware/stack_ip/ETH_DEF_HEADER_common.h"
#include "middleware/ethernet/ETH_porting.h"
#include "libtools/time/LIB_TIME_public.h"

 void ETH_IP_Manage ( const ts_CMN_IOSP_BUFFER * const p_Data ,                      ts_CMN_IOSP_BUFFER * const p_DataReassembly ) {    const ts_ETH_IP_Header *   c_IPHeader_pt ;    uint32_t                   v_flagFragment ;    uint32_t                   v_offSetFragment ;    te_CMN_FLAG_VALIDITY       v_valid ;    v_valid = ETH_IP_Manage_L_Check ( p_Data ) ;    if ( v_valid == e_CMN_FLAG_NOT_VALID )    {       v_ETH_IP_ControlObj.s_IPstats.s_packet_rx.s_nok++ ;       p_DataReassembly->s_buffer = NULL ;       p_DataReassembly->s_buffer_size = 0UL ;    }    else    {       c_IPHeader_pt = (const ts_ETH_IP_Header *) ( p_Data->s_buffer + sizeof(ts_ETH_EthernetHeader) ) ;       v_flagFragment = (uint32_t)( (uint32_t)c_IPHeader_pt->s_IP_Flags_FragOffset & (uint32_t)K_ETH_IP_IS_FRAGMENT_MASK ) ;       v_offSetFragment = (uint32_t)( (uint32_t)c_IPHeader_pt->s_IP_Flags_FragOffset & (uint32_t)K_ETH_IP_FRAGMENT_OFFSET_MASK ) * ((uint32_t)K_ETH_IP_FRAG_OFFSET_LSB) ;       if ( ( v_flagFragment == 0UL ) && ( v_offSetFragment == 0UL ) )       {          p_DataReassembly->s_buffer = p_Data->s_buffer ; #if (ETH_FEC != 0 )          p_DataReassembly->s_buffer_size = p_Data->s_buffer_size - K_ETH_IP_FCS_SIZE ; #else          p_DataReassembly->s_buffer_size = p_Data->s_buffer_size ; #endif       }       else       {          ETH_IP_Reassembly ( p_Data ,                              v_offSetFragment ,                              v_flagFragment ,                              &v_valid ) ;          if ( v_valid == e_CMN_FLAG_NOT_VALID )          {             v_ETH_IP_ControlObj.s_IPstats.s_packet_rx.s_nok ++ ;          }          else          {             switch ( v_ETH_IP_ControlObj.s_RxFragment.s_IPFRx_status )             {                case e_ETH_IP_FRGMT_IN_PROG :                   p_DataReassembly->s_buffer = NULL ;                   p_DataReassembly->s_buffer_size = 0UL ;                   break ;                case e_ETH_IP_FRGMT_FINISH :                   v_ETH_IP_ControlObj.s_IPstats.s_packet_rx.s_handled++ ;                   p_DataReassembly->s_buffer = v_ETH_IP_ControlObj.s_RxFragment.s_Packetbuff ;                   p_DataReassembly->s_buffer_size = v_ETH_IP_ControlObj.s_RxFragment.s_dataLen ;                   break ;                case e_ETH_IP_FRGMT_TIMEOUT :                case e_ETH_IP_FRGMT_INVALID :                default :                   p_DataReassembly->s_buffer = NULL ;                   p_DataReassembly->s_buffer_size = 0UL ;                   v_ETH_IP_ControlObj.s_IPstats.s_packet_rx.s_dropped++ ;                   break ;             }          }       }    } }
